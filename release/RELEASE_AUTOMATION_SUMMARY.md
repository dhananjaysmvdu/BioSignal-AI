# Release Automation Summary

This document provides an overview of the automated release workflow and utilities for the Reflex Governance Architecture.

---

## Components Overview

### 1. Core Scripts

| Script | Purpose | Trigger | Exit Code |
|--------|---------|---------|-----------|
| `update_doi_reference.py` | Propagates Zenodo DOI to README, whitepaper, manifest generator | `release_utilities.yml` workflow | Always 0 |
| `export_reproducibility_capsule.py` | Bundles governance artifacts into ZIP with manifest | Manual / scheduled | Always 0 |

### 2. GitHub Workflows

| Workflow | Schedule | Trigger | Purpose |
|----------|----------|---------|---------|
| `release_utilities.yml` | On release publish | `release: published` or manual | DOI propagation + capsule tagging |
| `governance_transparency_manifest.yml` | Daily 03:00 UTC | Cron + manual | Badge generation, manifest refresh, weekly snapshots |
| `audit_provenance_history.yml` | Weekly Sunday 05:00 UTC | Cron + manual | Integrity sentinel, registry, validator, ledger |

### 3. Data Files

| File | Format | Purpose | Generated By |
|------|--------|---------|--------------|
| `zenodo_metadata.json` | JSON | Zenodo deposit template (manual edit) | Human-created |
| `zenodo.json` | JSON | Actual minted DOI from Zenodo | Zenodo webhook (auto) |
| `exports/capsule_manifest.json` | JSON | Reproducibility capsule inventory with SHA-256 hashes | `export_reproducibility_capsule.py` |
| `exports/governance_reproducibility_capsule_YYYY-MM-DD.zip` | ZIP | Complete governance artifact bundle | `export_reproducibility_capsule.py` |

---

## Release Workflow Sequence

### Automated Release Flow

```
┌─────────────────────────────────────────────────────────────┐
│  1. Human: Publish GitHub Release (v1.0.0-Whitepaper)      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  2. Zenodo: Webhook receives release event                  │
│     • Downloads release tarball                              │
│     • Creates draft deposit with metadata                    │
│     • Mints DOI: 10.5281/zenodo.XXXXXXX                     │
│     • Publishes deposit (auto)                               │
│     • Creates zenodo.json in repo (via API or manual)       │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  3. GitHub Actions: release_utilities.yml triggers          │
│     • Checkout main branch                                   │
│     • Setup Python 3.11                                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  4. update_doi_reference.py executes                        │
│     • Reads zenodo.json for DOI                             │
│     • Updates README.md (citation block)                     │
│     • Updates docs/GOVERNANCE_WHITEPAPER.md (**DOI:** line) │
│     • Updates generate_transparency_manifest.py (template)   │
│     • Stages changes: git add                                │
│     • Commits: "docs: propagate Zenodo DOI..."              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  5. Workflow: Push DOI updates                              │
│     • Checks if commits ahead of origin/main                 │
│     • git push (if changes exist)                            │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  6. Workflow: Tag reproducibility capsule                   │
│     • Creates annotated tag: capsule-YYYY-MM-DD             │
│     • Message: "Governance reproducibility capsule DATE"     │
│     • git push origin capsule-YYYY-MM-DD                    │
│     • Idempotent: skips if tag already exists                │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  7. Result: Release complete                                │
│     ✅ DOI propagated to all documentation                   │
│     ✅ Capsule tag created for versioned artifact export     │
│     ✅ GitHub + Zenodo synchronized                          │
└─────────────────────────────────────────────────────────────┘
```

---

## Manual Intervention Points

### Before Release

1. **Review `zenodo_metadata.json`**:
   - Update `creators[0].orcid` if available
   - Verify `publication_date` matches release date
   - Update `related_identifiers[2]` with correct capsule tag date

2. **Generate reproducibility capsule**:
   ```powershell
   python scripts/workflow_utils/export_reproducibility_capsule.py
   git add exports/governance_reproducibility_capsule_*.zip exports/capsule_manifest.json
   git commit -m "release: add reproducibility capsule"
   git push origin main
   ```

3. **Test release workflow**:
   ```powershell
   gh workflow run release_utilities.yml
   git fetch --tags
   git tag --list "capsule-*"
   ```

### After Release (If Automation Fails)

1. **Manually create `zenodo.json`**:
   ```powershell
   @"
   {
     "doi": "10.5281/zenodo.XXXXXXX",
     "doi_url": "https://doi.org/10.5281/zenodo.XXXXXXX"
   }
   "@ | Out-File -Encoding UTF8 zenodo.json
   git add zenodo.json
   git commit -m "docs: add Zenodo DOI metadata"
   git push origin main
   ```

2. **Trigger DOI updater**:
   ```powershell
   python scripts/workflow_utils/update_doi_reference.py
   ```

3. **Manually create capsule tag**:
   ```powershell
   $date = Get-Date -Format "yyyy-MM-dd"
   git tag -a "capsule-$date" -m "Governance reproducibility capsule $date"
   git push origin "capsule-$date"
   ```

---

## Idempotency Guarantees

### DOI Updater

- **Safe to run multiple times**: Replaces placeholders or updates existing DOI
- **No duplicate commits**: Uses git staging and diff check
- **Always exits 0**: Won't break CI pipeline

### Capsule Exporter

- **Date-based idempotency**: Checks if capsule already exists for today
- **Hash verification**: Compares SHA-256 before skipping regeneration
- **Atomic writes**: Writes manifest only after ZIP creation succeeds

### Capsule Tagger

- **Tag existence check**: `git rev-parse` verifies before creation
- **Skip message logged**: "Tag already exists; skipping creation"
- **No-op on reruns**: Safe to trigger workflow multiple times per day

---

## Troubleshooting

### Issue: `zenodo.json` not created after release

**Cause**: Zenodo webhook may take 5-10 minutes or fail silently  
**Solution**: Manually create `zenodo.json` (see template above) and trigger workflow

### Issue: DOI updater finds no changes

**Expected**: If DOI already propagated, script prints "No documentation updates required."  
**Action**: No action needed

### Issue: Capsule tag date mismatch

**Cause**: Workflow runs across midnight UTC boundary  
**Solution**: Tags are dated to workflow execution time (acceptable variance)

### Issue: Workflow fails on git push

**Cause**: Permission denied or branch protection rules  
**Solution**: 
1. Check workflow permissions: `contents: write`
2. Verify no branch protection on `main` blocks bot commits

---

## Testing Commands

### Dry-Run Full Sequence

```powershell
# 1. Generate capsule
python scripts/workflow_utils/export_reproducibility_capsule.py

# 2. Create mock zenodo.json
@"
{
  "doi": "10.5281/zenodo.TEST1234"
}
"@ | Out-File -Encoding UTF8 zenodo.json

# 3. Run DOI updater
python scripts/workflow_utils/update_doi_reference.py

# 4. Check updates
git status
git diff README.md

# 5. Cleanup test
git restore README.md docs/GOVERNANCE_WHITEPAPER.md scripts/workflow_utils/generate_transparency_manifest.py
Remove-Item zenodo.json
```

### Verify Capsule Contents

```powershell
$capsule = Get-ChildItem exports/governance_reproducibility_capsule_*.zip | Select-Object -First 1
Expand-Archive -Path $capsule.FullName -DestinationPath temp_verify -Force
Get-ChildItem temp_verify -Recurse | Select-Object FullName
Remove-Item temp_verify -Recurse -Force
```

### Validate Manifest JSON

```powershell
$manifest = Get-Content exports/capsule_manifest.json | ConvertFrom-Json
Write-Host "Capsule SHA-256: $($manifest.capsule.sha256)"
Write-Host "File count: $($manifest.files.Count)"
$manifest.files | Select-Object path, size | Format-Table
```

---

## Future Enhancements

### Potential Additions

1. **Automatic capsule generation on release**:
   - Add step to `release_utilities.yml` before tagging
   - Ensures capsule always includes latest artifacts

2. **Zenodo API integration**:
   - Use `zenodopy` or REST API to fetch DOI programmatically
   - Eliminates need for manual `zenodo.json` creation

3. **Multi-version capsule management**:
   - Keep last N capsules (e.g., 5 most recent)
   - Archive older capsules to external storage

4. **Slack/Discord notifications**:
   - Alert on successful release + DOI minting
   - Notify team when capsule tag created

---

## Documentation Index

- **[RELEASE_PREPARATION_v1.0.0.md](RELEASE_PREPARATION_v1.0.0.md)** - Comprehensive pre-release checklist
- **[QUICK_START_MANUAL_TEST.md](QUICK_START_MANUAL_TEST.md)** - Quick manual workflow test guide
- **[DRY_RUN_TESTING_GUIDE.md](DRY_RUN_TESTING_GUIDE.md)** - Detailed testing procedures for all utilities
- **[ZENODO_RELEASE_CHECKLIST.md](ZENODO_RELEASE_CHECKLIST.md)** - Step-by-step Zenodo setup and release process
- **[RELEASE_AUTOMATION_SUMMARY.md](RELEASE_AUTOMATION_SUMMARY.md)** - This document

---

**Last Updated**: 2025-11-11  
**Next Review**: After v1.0.0-Whitepaper release completion
