name: MVCRS Stability Convergence Engine (Phase XLIV)

on:
  schedule:
    - cron: '55 8 * * *'
  workflow_dispatch: {}

jobs:
  convergence-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          pip install -r requirements.txt || true
      - name: Run Stability Convergence engine
        run: |
          python scripts/convergence/mvcrs_stability_convergence.py || exit $?
      - name: Evaluate convergence gating
        run: |
          python -c "import json,sys,pathlib; p=pathlib.Path('state/mvcrs_stability_convergence.json'); prof=json.loads(p.read_text()) if p.exists() else {}; risk=prof.get('potential_gating_risk',False); print(f'Gating risk: {risk}'); sys.exit(1 if risk else 0)"
      - name: On failure - create fix branch
        if: failure()
        run: |
          python -c "import datetime,subprocess,pathlib; ts=datetime.datetime.utcnow().strftime('%Y%m%dT%H%M%SZ'); branch=f'fix/mvcrs-stability-convergence-{ts}'; subprocess.run(['git','checkout','-b',branch]); summary=pathlib.Path('INSTRUCTION_EXECUTION_SUMMARY.md'); content=summary.read_text(); lines=[l for l in content.split('\n') if 'MVCRS_STABILITY_CONVERGENCE:' not in l]; lines.append(f'<!-- MVCRS_STABILITY_CONVERGENCE: FAILED {ts} -->'); summary.write_text('\n'.join(lines))"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: convergence-artifacts
          path: |
            state/mvcrs_stability_convergence.json
            logs/mvcrs_stability_convergence_log.jsonl
