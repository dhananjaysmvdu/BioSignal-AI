name: Verify Coverage Badge Signature

on:
  push:
    branches: [ main ]

jobs:
  verify-badge:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure GPG available
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gnupg
          gpg --version

      - name: Import public key
        run: |
          if [ -f .github/public_keys/badge_signing.pub ]; then
            gpg --import .github/public_keys/badge_signing.pub
          else
            echo 'Public key not found; failing.'
            exit 1
          fi

      - name: Verify latest commit signature
        id: sig
        run: |
          OUT=$(git log -1 --show-signature 2>&1 || true)
          echo "$OUT"
          echo "signature_output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "$OUT" | grep -q "Good signature from" || (echo 'Signature NOT valid'; exit 1)
          echo "$OUT" | grep -q "Coverage Badge CI" || (echo 'Signer identity mismatch'; exit 1)

      - name: Verify badge file integrity
        run: |
          if [ ! -f badges/coverage.sig ] || [ ! -f badges/coverage.svg ]; then
            echo 'Badge or signature file missing.'
            exit 1
          fi
          cd badges
          sha256sum -c coverage.sig || (echo 'coverage.svg hash mismatch vs signature file'; exit 1)
          cd ..

      - name: Verify versions.json chain
        run: |
          if [ ! -f reports/history/versions.json ]; then
            echo 'versions.json missing'; exit 1; fi
          SIG_HASH=$(sha256sum badges/coverage.sig | awk '{print $1}')
          FILE_HASH=$(python scripts/workflow_utils/extract_coverage_hash.py)
          echo "Computed signature file SHA256: $SIG_HASH"
          echo "Recorded coverage_badge_hash: $FILE_HASH"
          if [ "$SIG_HASH" != "$FILE_HASH" ]; then
            echo 'coverage_badge_hash mismatch'; exit 1; fi

      - name: Success report
        run: |
          echo "âœ… Badge provenance and commit signature verified."
          # Extract contextual provenance info
          SIG_OUT=$(git log -1 --show-signature)
          # Key ID can appear as either "using RSA key <KEY>" or "key ID <KEY>"
          KEY_ID=$(echo "$SIG_OUT" | sed -n -E 's/.*using [A-Z0-9]+ key ([0-9A-Fa-f]+)/\1/p; s/.*key ID ([0-9A-Fa-f]+)/\1/p' | head -n1)
          # Primary key fingerprint line
          FPR=$(echo "$SIG_OUT" | sed -n -E 's/^gpg: Primary key fingerprint: (.*)/\1/p' | head -n1 | sed -E 's/^\s+|\s+$//g')
          # Commit hash and timestamp (UTC)
          COMMIT=$(git rev-parse HEAD)
          TS=$(date -u -d @"$(git log -1 --format=%ct)" '+%Y-%m-%d %H:%M:%S')

          # Coverage: parse latest coverage.xml if present
          COV_FILE=$(find . -maxdepth 5 -type f -name 'coverage.xml' | head -n1 || true)
          if [ -n "$COV_FILE" ]; then
            VAL=$(grep -m1 -o 'line-rate="[^"]*"' "$COV_FILE" | sed -E 's/.*line-rate="([^"]+)".*/\1/' || true)
            if [ -n "$VAL" ]; then
              COV_PCT=$(python3 -c "v='$VAL'; print(f'{float(v)*100:.1f}%')")
            else
              COV_PCT="N/A"
            fi
          else
            COV_PCT="N/A"
          fi

          echo "### ðŸ§© Coverage Badge Provenance Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Signer:** Coverage Badge CI" >> $GITHUB_STEP_SUMMARY
          echo "- **Key ID:** ${KEY_ID:-unknown}" >> $GITHUB_STEP_SUMMARY
          echo "- **Fingerprint:** ${FPR:-unknown}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${COMMIT}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** ${TS} UTC" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage:** ${COV_PCT}" >> $GITHUB_STEP_SUMMARY
          echo "- **Integrity:** Verified âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Commit](https://github.com/${GITHUB_REPOSITORY}/commit/${COMMIT})" >> $GITHUB_STEP_SUMMARY