name: Audit Provenance History

on:
  schedule:
    - cron: "0 5 * * 0"  # Sundays at 05:00 UTC

jobs:
  audit-history:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    outputs:
      conf: ${{ steps.forecast.outputs.conf }}
      drift: ${{ steps.forecast.outputs.drift }}
      audit_depth: ${{ steps.policy.outputs.audit_depth }}
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq and gnupg
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq gnupg
          jq --version
          gpg --version

      - name: Import badge public key
        id: pubkey
        run: |
          if [ ! -f .github/public_keys/badge_signing.pub ]; then
            echo "Public key not found at .github/public_keys/badge_signing.pub" >&2
            exit 1
          fi
          gpg --import .github/public_keys/badge_signing.pub
          PUB_FPR=$(gpg --show-keys --with-colons .github/public_keys/badge_signing.pub | awk -F: '/^fpr:/{print $10; exit}')
          PUB_FPR_CLEAN=$(echo "$PUB_FPR" | tr -d ' ')
          echo "Imported public key fingerprint: $PUB_FPR"  # full forensics log
          echo "pub_fpr=$PUB_FPR_CLEAN" >> $GITHUB_OUTPUT

      - name: Audit last 10 provenance entries
        id: audit
        env:
          PUB_FPR: ${{ steps.pubkey.outputs.pub_fpr }}
        run: |
          set -e
          if [ ! -f reports/history/versions.json ]; then
            echo "versions.json not found at reports/history/versions.json" >&2
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "No versions.json present; nothing to audit." >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Prepare entries (commit and expected sig hash) from various possible schemas
          mapfile -t ENTRIES < <(jq -r '
            ((.versions // .history // .entries // .) | (if type=="array" then . else [] end))
            | (if length>10 then .[-10:] else . end)
            | map({c: (.commit // .sha // .hash // .rev // .revision // .id), h: (.coverage_badge_hash // .coverageHash // .coverage_sig_sha256)})
            | map(select(.c!=null and .h!=null))
            | .[] | "\(.c) \(.h)"' reports/history/versions.json)

          PASS_CNT=0
          FAIL_CNT=0
          FAIL_LOG=""
          FAIL_COMMITS=""
          CHECKED=${#ENTRIES[@]}

          for line in "${ENTRIES[@]}"; do
            COMMIT=$(echo "$line" | awk '{print $1}')
            EXPECTED=$(echo "$line" | awk '{print $2}')
            echo "\nAuditing commit $COMMIT ..."

            # 1) Verify signature matches imported key
            SIG_OUT=$(git log -1 --show-signature "$COMMIT" 2>&1 || true)
            echo "$SIG_OUT"
            COMMIT_FPR=$(echo "$SIG_OUT" | sed -n -E 's/^gpg: Primary key fingerprint: (.*)/\1/p' | head -n1 | tr -d ' ')
            if [ -z "$COMMIT_FPR" ]; then
              echo "‚ùå No GPG fingerprint found in signature output for $COMMIT"
              FAIL_CNT=$((FAIL_CNT+1))
              FAIL_LOG+="- $COMMIT: missing signature or fingerprint\n"
              FAIL_COMMITS+="$COMMIT\n"
              continue
            fi
            if [ "$COMMIT_FPR" != "$PUB_FPR" ]; then
              echo "‚ùå Fingerprint mismatch: commit uses $COMMIT_FPR, expected $PUB_FPR"
              FAIL_CNT=$((FAIL_CNT+1))
              FAIL_LOG+="- $COMMIT: fingerprint mismatch\n"
              FAIL_COMMITS+="$COMMIT\n"
              continue
            fi
            echo "‚úÖ Signature fingerprint matches imported key"

            echo "$SIG_OUT" | grep -q "Good signature from" || {
              echo "‚ùå Signature not valid for $COMMIT"; FAIL_CNT=$((FAIL_CNT+1)); FAIL_LOG+="- $COMMIT: signature invalid\n"; FAIL_COMMITS+="$COMMIT\n"; continue; }

            # 2) Verify coverage.sig hash at that revision
            if ! git cat-file -e "$COMMIT:badges/coverage.sig" 2>/dev/null; then
              echo "‚ùå badges/coverage.sig missing at $COMMIT"
              FAIL_CNT=$((FAIL_CNT+1))
              FAIL_LOG+="- $COMMIT: coverage.sig missing\n"
              FAIL_COMMITS+="$COMMIT\n"
              continue
            fi
            TMP=$(mktemp)
            git show "$COMMIT:badges/coverage.sig" > "$TMP"
            ACTUAL=$(sha256sum "$TMP" | awk '{print $1}')
            rm -f "$TMP"
            if [ "$ACTUAL" != "$EXPECTED" ]; then
              echo "‚ùå coverage.sig SHA256 mismatch (expected $EXPECTED, got $ACTUAL)"
              FAIL_CNT=$((FAIL_CNT+1))
              FAIL_LOG+="- $COMMIT: coverage.sig hash mismatch\n"
              FAIL_COMMITS+="$COMMIT\n"
              continue
            fi
            echo "‚úÖ coverage.sig hash matches versions.json entry"

            PASS_CNT=$((PASS_CNT+1))
          done

          echo "pass=$PASS_CNT" >> $GITHUB_OUTPUT
          echo "fail=$FAIL_CNT" >> $GITHUB_OUTPUT
          echo "checked=$CHECKED" >> $GITHUB_OUTPUT
          # Preserve detailed failure list (may be empty)
          echo "fail_log<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FAIL_LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "fail_commits<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FAIL_COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Step summary
          echo "### üîé Provenance Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Checked: $CHECKED" >> $GITHUB_STEP_SUMMARY
          echo "- Verified: $PASS_CNT" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: $FAIL_CNT" >> $GITHUB_STEP_SUMMARY
          if [ "$FAIL_CNT" -gt 0 ]; then
            echo "\n#### Failures" >> $GITHUB_STEP_SUMMARY
            echo -e "$FAIL_LOG" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Open or update drift issue on failures
        if: ${{ steps.audit.outputs.fail && steps.audit.outputs.fail != '0' }}
        id: issue
        env:
          FAIL_LOG: ${{ steps.audit.outputs.fail_log }}
        run: |
          TITLE="Provenance drift detected"
          # Find existing open issue with same title
          EXISTING=$(curl -s -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues?state=open\&per_page=100 | \
            jq -r --arg t "$TITLE" '.[] | select(.title==$t) | .number' | head -n1)
          if [ -n "$EXISTING" ]; then
            echo "Existing issue #$EXISTING found. Appending comment."
            BODY="New failures detected by scheduled audit:\n\n${FAIL_LOG}"
            curl -s -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/$EXISTING/comments \
              -d "$(jq -nc --arg b "$BODY" '{body:$b}')"
            echo "issue_url=https://github.com/${{ github.repository }}/issues/$EXISTING" >> $GITHUB_OUTPUT
          else
            echo "Creating new issue: $TITLE"
            BODY="The scheduled provenance audit detected the following failures:\n\n${FAIL_LOG}"
            RESP=$(curl -s -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${{ github.repository }}/issues \
              -d "$(jq -nc --arg t "$TITLE" --arg b "$BODY" '{title:$t, body:$b}')")
            URL=$(echo "$RESP" | jq -r '.html_url')
            echo "issue_url=$URL" >> $GITHUB_OUTPUT
          fi

      - name: Auto-remediation (regenerate badge)
        if: ${{ steps.audit.outputs.fail && steps.audit.outputs.fail != '0' }}
        env:
          FAIL_COMMITS: ${{ steps.audit.outputs.fail_commits }}
        run: |
          echo "Triggering coverage_badge.yml via workflow_dispatch for remediation"
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/coverage_badge.yml/dispatches \
            -d '{"ref":"main"}'
          # Log per-commit remediation note
          echo "\n#### Auto-remediation" >> $GITHUB_STEP_SUMMARY
          while IFS= read -r c; do
            [ -n "$c" ] || continue
            echo "üõ†Ô∏è Auto-remediation triggered for $c" | tee -a $GITHUB_STEP_SUMMARY
          done <<< "$FAIL_COMMITS"

      - name: Generate executive audit summary
        run: |
          mkdir -p reports
          TS=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          CHECKED=${{ steps.audit.outputs.checked || 0 }}
          PASSED=${{ steps.audit.outputs.pass || 0 }}
          FAILED=${{ steps.audit.outputs.fail || 0 }}
          REMEDIATED=${{ steps.audit.outputs.fail || 0 }}
          ISSUE_URL=${{ steps.issue.outputs.issue_url || '' }}
          WF_LINK="https://github.com/${{ github.repository }}/actions/workflows/coverage_badge.yml"
          STATUS=$([ "$FAILED" -gt 0 ] && echo "ATTENTION REQUIRED" || echo "PASS")
          {
            echo "# Weekly Provenance Audit Summary"
            echo
            echo "- Timestamp: $TS"
            echo "- Auditor: GitHub Actions bot"
            echo "- Commits checked: $CHECKED"
            echo "- Passed: $PASSED"
            echo "- Failed: $FAILED"
            echo "- Remediated: $REMEDIATED"
            echo "- Issue: ${ISSUE_URL:-N/A}"
            echo "- Workflow: $WF_LINK"
            echo "- Overall Status: $STATUS"
          } > reports/audit_summary.md
          # Append dashboard link into step summary now (generated next)
          echo "\n[Provenance Dashboard](reports/provenance_dashboard.html)" >> $GITHUB_STEP_SUMMARY

      - name: Generate provenance insights dashboard
        run: |
          python scripts/workflow_utils/generate_provenance_dashboard.py
      - name: Forecast provenance risk
        id: forecast
        run: |
          python scripts/workflow_utils/forecast_provenance_risk.py > forecast_output.json
          DRIFT=$(jq -r '.predicted_drift_probability_pct' forecast_output.json || echo 0)
          REM=$(jq -r '.expected_remediations' forecast_output.json || echo 0)
          CONF=$(jq -r '.confidence_pct' forecast_output.json || echo 0)
          echo "drift=$DRIFT" >> $GITHUB_OUTPUT
          echo "rem=$REM" >> $GITHUB_OUTPUT
          echo "conf=$CONF" >> $GITHUB_OUTPUT
          echo "\nüîÆ Next-week drift probability: ${DRIFT}%" >> $GITHUB_STEP_SUMMARY
          echo "üß© Confidence: ${CONF}%" >> $GITHUB_STEP_SUMMARY
          echo "‚öôÔ∏è Expected remediations: ${REM}" >> $GITHUB_STEP_SUMMARY
      - name: Adaptive governance tuning
        id: policy
        run: |
          python scripts/workflow_utils/prescriptive_controller.py > policy_output.json
          AUDIT_DEPTH=$(jq -r '.policy.audit_depth' policy_output.json || echo unknown)
          DRIFT_THRESH=$(jq -r '.policy.drift_threshold' policy_output.json || echo 0)
          NEXT_AUDIT=$(jq -r '.policy.next_audit_date' policy_output.json || echo unknown)
          echo "audit_depth=$AUDIT_DEPTH" >> $GITHUB_OUTPUT
          echo "drift_threshold=$DRIFT_THRESH" >> $GITHUB_OUTPUT
          echo "next_audit=$NEXT_AUDIT" >> $GITHUB_OUTPUT
          echo "‚öñÔ∏è Audit depth set to: $AUDIT_DEPTH" >> $GITHUB_STEP_SUMMARY
          echo "üßÆ New drift threshold: $DRIFT_THRESH" >> $GITHUB_STEP_SUMMARY
          echo "üïí Next scheduled audit: $NEXT_AUDIT" >> $GITHUB_STEP_SUMMARY

      - name: Explain policy decision
        run: |
          python scripts/workflow_utils/explain_policy_adjustment.py > rationale_output.txt
          echo "üìú Generated compliance explanation for latest policy decision" >> $GITHUB_STEP_SUMMARY

      - name: Commit executive audit summary
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add reports/audit_summary.md reports/provenance_dashboard.html reports/provenance_forecast.json configs/governance_policy.json reports/compliance_rationale.md logs/decision_trace.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ci: add explainable compliance rationale for adaptive governance."
            git push
          fi

  human-oversight:
    needs: [audit-history]
    if: ${{ needs.audit-history.outputs.conf != '' && (fromJSON(needs.audit-history.outputs.conf) < 80 || fromJSON(needs.audit-history.outputs.drift) >= 30 || needs.audit-history.outputs.audit_depth == 'moderate' || needs.audit-history.outputs.audit_depth == 'full') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run human oversight gateway
        id: gateway
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python scripts/workflow_utils/human_oversight_gateway.py
          echo "üß† Human review initiated for high-risk policy change." >> $GITHUB_STEP_SUMMARY
      - name: Generate standardized review template
        id: template
        env:
          REVIEWER: ${{ github.triggering_actor }}
        run: |
          python scripts/workflow_utils/generate_review_template.py > /dev/null
          DID=$(jq -r '.decision_id' "$GITHUB_STEP_SUMMARY" 2>/dev/null || echo "")
          echo "üìù Generated standardized review form." >> $GITHUB_STEP_SUMMARY

      - name: Update audit summary with pending review
        env:
          CONF: ${{ needs.audit-history.outputs.conf }}
          DEPTH: ${{ needs.audit-history.outputs.audit_depth }}
        run: |
          mkdir -p reports
          DID=$(date -u +"%Y%m%dT%H%M%SZ")
          RISK=$([ "$DEPTH" = "full" ] && echo "high" || ([ "$DEPTH" = "moderate" ] && echo "medium" || echo "low"))
          ASSIGNEE="unassigned"
          {
            echo ""
            echo "## Pending Review:"
            echo "Decision ID | Risk | Confidence | Assigned Reviewer"
            echo "---|---|---:|---"
            echo "$DID | $RISK | ${CONF}% | $ASSIGNEE"
          } >> reports/audit_summary.md

      - name: Commit review request and audit summary
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add reports/review_request.md reports/reviews/pending/* reports/audit_summary.md logs/decision_trace.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ci: add standardized human review template generator for oversight consistency"
            git push
          fi

  record-human-review:
    needs: [human-oversight]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Record human review outcomes
        id: record
        run: |
          python scripts/workflow_utils/record_human_review.py
      - name: Commit governance ledger updates
        run: |
          if [ -f logs/oversight_ledger.json ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add logs/oversight_ledger.json reports/audit_summary.md reports/reviews/completed/* || true
            if git diff --cached --quiet; then
              echo "No ledger updates to commit."
            else
              git commit -m "ci: record human oversight outcomes and update governance ledger"
              git push
            fi
          fi

  learn-meta:
    needs: [record-human-review]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Integrate human feedback into policy
        run: |
          python scripts/workflow_utils/learn_from_reviews.py > meta_out.json
          echo "üß† Learned from human oversight feedback." >> $GITHUB_STEP_SUMMARY
      - name: Commit meta-learning updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add configs/governance_policy.json reports/audit_summary.md
          if git diff --cached --quiet; then
            echo "No meta-learning changes to commit."
          else
            git commit -m "ci: integrate human feedback into adaptive governance learning loop"
            git push
          fi

  score-reviewers:
    needs: [learn-meta]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      trust_index: ${{ steps.trust.outputs.trust_index }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.lock

      - name: Run reviewer reliability scoring
        run: |
          python scripts/workflow_utils/score_reviewer_reliability.py

      - name: Regenerate provenance dashboard
        run: |
          python scripts/workflow_utils/generate_provenance_dashboard.py

      - name: Compute and publish trust index (optional)
        id: trust
        shell: bash
        run: |
          python - <<'PY'
          import json, os
          def load_json(p, default=None):
              try:
                  with open(p,'r',encoding='utf-8') as f:
                      return json.load(f)
              except Exception:
                  return default
          scores = load_json('logs/reviewer_scores.json', {}) or {}
          ledger = load_json('logs/oversight_ledger.json', []) or []
          alignments = [float(v.get('alignment',0.0)) for v in (scores.values() if isinstance(scores, dict) else [])]
          mean_alignment = (sum(alignments)/len(alignments)) if alignments else 0.0
          approvals = sum(1 for e in ledger if str(e.get('verdict','')).lower()=='approved')
          total = len(ledger)
          disagreement_rate = 1.0 - (approvals/total) if total else 0.0
          trust_index = max(0.0, min(1.0, mean_alignment * (1.0 - disagreement_rate)))
          # Export as percentage with 2 decimals
          with open(os.environ['GITHUB_OUTPUT'],'a', encoding='utf-8') as g:
              g.write(f"trust_index={trust_index*100:.2f}\n")
          with open(os.environ['GITHUB_STEP_SUMMARY'],'a', encoding='utf-8') as s:
              s.write(f"\nüîê Oversight Trust Index: {trust_index*100:.2f}%\n")
          PY

      - name: Commit reviewer metrics and dashboard
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add logs/reviewer_scores.json reports/provenance_dashboard.html reports/audit_summary.md
          if git diff --cached --quiet; then
            echo "No reviewer metrics or dashboard changes to commit."
          else
            git commit -m "ci: integrate reviewer reliability scoring and regenerate provenance dashboard"
            git push
          fi

      - name: Append run summary
        run: |
          echo "üìä Reviewer reliability metrics updated ‚Äî Oversight Trust Index recalculated." >> $GITHUB_STEP_SUMMARY

  generate-trust-badge:
    needs: [score-reviewers]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.lock
      - name: Generate Oversight Trust Index badge
        id: badge
        run: |
          python scripts/workflow_utils/generate_trust_badge.py > trust_badge.json
          TRUST=$(jq -r '.trust_index_pct' trust_badge.json || echo 0)
          echo "Trust Index: ${TRUST}%" >> $GITHUB_STEP_SUMMARY
      - name: Verify trust badge signature
        run: |
          cd badges
          sha256sum -c trust_index.sig
      - name: Commit trust badge and summary
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add badges/trust_index.svg badges/trust_index.sig README.md reports/audit_summary.md
          if git diff --cached --quiet; then
            echo "No trust badge changes to commit."
          else
            git commit -m "ci: publish Oversight Trust Index badge"
            git push
          fi

  update-policy-from-trust:
    needs: [generate-trust-badge]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.lock
      - name: Adapt governance policy from Trust Index
        id: adapt
        run: |
          python scripts/workflow_utils/update_policy_from_trust_index.py > trust_policy.json
          TI=$(jq -r '.trust_index_pct' trust_policy.json || echo 0)
          echo "trust_index=${TI}" >> $GITHUB_OUTPUT
          echo "‚öôÔ∏è Governance policy adapted based on Oversight Trust Index (${TI}%)." >> $GITHUB_STEP_SUMMARY
      - name: Commit adapted policy
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add configs/governance_policy.json reports/audit_summary.md logs/decision_trace.json
          if git diff --cached --quiet; then
            echo "No governance policy changes to commit."
          else
            git commit -m "ci: adapt governance policy based on Oversight Trust Index"
            git push
          fi

  compute-governance-health:
    needs: [update-policy-from-trust]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.lock
      - name: Compute Governance Health Score
        id: ghs
        run: |
          python scripts/workflow_utils/compute_governance_health.py > ghs_output.json
          GHS=$(jq -r '.GovernanceHealthScore' ghs_output.json || echo 0)
          echo "ghs=${GHS}" >> $GITHUB_OUTPUT
          STATUS="Critical"
          if [ "$(printf '%.0f' "$GHS")" -ge 80 ]; then STATUS="Healthy"; elif [ "$(printf '%.0f' "$GHS")" -ge 60 ]; then STATUS="Attention"; fi
          echo "üßÆ Governance Health Score: ${GHS}%" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Status: ${STATUS}" >> $GITHUB_STEP_SUMMARY
      - name: Verify governance health badge signature
        run: |
          cd badges
          sha256sum -c governance_health.sig
      - name: Commit governance health artifacts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add reports/governance_health.json badges/governance_health.svg badges/governance_health.sig reports/audit_summary.md README.md
          if git diff --cached --quiet; then
            echo "No governance health changes to commit."
          else
            git commit -m "ci: compute and publish composite Governance Health Score and badge"
            git push
          fi

  update-governance-cycle:
    needs: [compute-governance-health]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.lock
      - name: Adapt governance cycle from GHS
        id: cycle
        run: |
          python scripts/workflow_utils/update_governance_cycle.py > cycle_output.json
          GHS=$(jq -r '.ghs' cycle_output.json || echo 0)
          FREQ=$(jq -r '.audit_frequency' cycle_output.json || echo unknown)
          echo "ghs=${GHS}" >> $GITHUB_OUTPUT
          echo "audit_frequency=${FREQ}" >> $GITHUB_OUTPUT
          echo "üîÅ Governance cycle updated based on GHS = ${GHS}%" >> $GITHUB_STEP_SUMMARY
          echo "üïí Next audit in ${FREQ}" >> $GITHUB_STEP_SUMMARY
      - name: Commit governance cycle changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add configs/governance_policy.json logs/decision_trace.json reports/audit_summary.md
          if git diff --cached --quiet; then
            echo "No governance cycle changes to commit."
          else
            git commit -m "ci: adapt governance meta-learning and audit schedule from Governance Health Score"
            git push
          fi
      - name: Regenerate Governance Pulse dashboard
        run: |
          python scripts/workflow_utils/generate_provenance_dashboard.py
      - name: Commit updated dashboard and summary
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add reports/provenance_dashboard.html reports/audit_summary.md
          if git diff --cached --quiet; then
            echo "No dashboard changes to commit."
          else
            git commit -m "ci: update Governance Pulse dashboard with temporal adaptation visualization"
            git push
          fi
      - name: Append dashboard update note
        run: |
          echo "üìà Governance Pulse dashboard updated ‚Äî GHS trend and cadence timeline refreshed." >> $GITHUB_STEP_SUMMARY

  record-governance-history:
    needs: [update-governance-cycle]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.lock
      - name: Record governance history snapshot
        run: |
          python scripts/workflow_utils/record_governance_history.py > gov_hist.json
          COUNT=$(jq -r '.written' gov_hist.json || echo 0)
          echo "üß≠ Recorded governance history snapshot ‚Äî timeline extended (entries=${COUNT})." >> $GITHUB_STEP_SUMMARY
      - name: Commit governance history
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add reports/history/versions.json
          if git diff --cached --quiet; then
            echo "No governance history changes to commit."
          else
            git commit -m "ci: record governance history snapshot for Governance Pulse timeline"
            git push
          fi
      - name: Regenerate dashboard with coefficient trends
        run: |
          python scripts/workflow_utils/generate_provenance_dashboard.py
      - name: Commit updated dashboard (meta-learning trends)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add reports/provenance_dashboard.html
          if git diff --cached --quiet; then
            echo "No dashboard coefficient trend changes to commit."
          else
            git commit -m "ci: extend governance history and pulse dashboard with meta-learning coefficient trends"
            git push
          fi
      - name: Append coefficient trends summary
        run: |
          echo "üß™ Meta-learning coefficient trends plotted on Governance Pulse dashboard." >> $GITHUB_STEP_SUMMARY

  compute-meta-stability:
    needs: [record-governance-history]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.lock
      - name: Compute meta-stability index
        id: msi
        run: |
          python scripts/workflow_utils/compute_meta_stability.py > msi_out.json
          MSI=$(jq -r '.meta_stability_index' msi_out.json || echo 0)
          echo "msi=${MSI}" >> $GITHUB_OUTPUT
          echo "üß† Meta-Stability Index computed: ${MSI}%" >> $GITHUB_STEP_SUMMARY
      - name: Regenerate dashboard with stability gauge
        run: |
          python scripts/workflow_utils/generate_provenance_dashboard.py
      - name: Commit meta-stability artifacts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add reports/meta_stability.json reports/audit_summary.md reports/provenance_dashboard.html
          if git diff --cached --quiet; then
            echo "No meta-stability changes to commit."
          else
            git commit -m "ci: add meta-stability index and learning stability gauge to governance dashboard"
            git push
          fi
      - name: Append stability gauge summary
        run: |
          echo "üìä Meta-Stability Index computed ‚Äî learning stability gauge updated." >> $GITHUB_STEP_SUMMARY

  adaptive-learning-rate:
    needs: [compute-meta-stability]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.lock
      - name: Apply adaptive learning rate control
        id: adapt
        run: |
          python scripts/workflow_utils/adaptive_learning_rate_controller.py > alrc_out.json
          RATE=$(jq -r '.learning_rate_factor' alrc_out.json || echo 1.0)
          MSI=$(jq -r '.msi' alrc_out.json || echo 0)
          echo "rate_factor=${RATE}" >> $GITHUB_OUTPUT
          echo "msi=${MSI}" >> $GITHUB_OUTPUT
          echo "‚öñÔ∏è Adaptive meta-learning rate adjusted: MSI=${MSI}% ‚Üí √ó${RATE}" >> $GITHUB_STEP_SUMMARY
      - name: Commit adaptive learning rate updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add configs/governance_policy.json reports/audit_summary.md
          if git diff --cached --quiet; then
            echo "No adaptive learning rate changes to commit."
          else
            git commit -m "ci: apply adaptive meta-learning rate control based on meta-stability feedback"
            git push
          fi
      - name: Append adaptive rate summary
        run: |
          echo "‚öñÔ∏è Adaptive meta-learning rate adjusted from MSI feedback." >> $GITHUB_STEP_SUMMARY

  evaluate-adaptation-outcomes:
    needs: [adaptive-learning-rate]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.lock
      - name: Evaluate adaptation outcomes
        id: evaluate
        run: |
          python scripts/workflow_utils/evaluate_adaptation_outcomes.py > eval_out.json
          OUTCOME=$(jq -r '.outcome' eval_out.json || echo 'neutral')
          GHS_DELTA=$(jq -r '.ghs_delta' eval_out.json || echo 0)
          MSI_DELTA=$(jq -r '.msi_delta' eval_out.json || echo 0)
          echo "outcome=${OUTCOME}" >> $GITHUB_OUTPUT
          echo "ghs_delta=${GHS_DELTA}" >> $GITHUB_OUTPUT
          echo "msi_delta=${MSI_DELTA}" >> $GITHUB_OUTPUT
          echo "üìä Evaluated last adaptation ‚Äî outcome classified as ${OUTCOME^} (GHS Œî${GHS_DELTA}, MSI Œî${MSI_DELTA})." >> $GITHUB_STEP_SUMMARY
      - name: Commit adaptation outcome evaluation
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add logs/adaptation_outcomes.json reports/audit_summary.md
          if git diff --cached --quiet; then
            echo "No adaptation outcome changes to commit."
          else
            git commit -m "ci: record and evaluate adaptation outcomes for governance self-assessment"
            git push
          fi
      - name: Append evaluation summary
        run: |
          OUTCOME="${{ steps.evaluate.outputs.outcome }}"
          echo "üìä Evaluated last adaptation ‚Äî outcome classified as ${OUTCOME^}." >> $GITHUB_STEP_SUMMARY
