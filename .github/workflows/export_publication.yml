name: Export Publication Report

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * 1" # Weekly on Mondays at 04:00 UTC

jobs:
  export:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      commit_ok: ${{ steps.validate.outputs.commit_ok }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install weasyprint nbconvert mistune markdown pyyaml

      - name: Gather inputs and build combined HTML
        run: |
          echo "--- START: gather inputs and build combined HTML ---"
          python scripts/export_pub_build.py
          echo "--- END: gather inputs and build combined HTML ---"

      - name: Export PDF (WeasyPrint)
        id: weasy
        continue-on-error: true
        run: |
          echo "Starting WeasyPrint export (timeout 8m)"
          timeout 480s python - <<'PY' || echo 'WeasyPrint timed out or failed'
          from pathlib import Path
          from weasyprint import HTML

          html_path = Path('build/pub/combined.html')
          pdf_path = Path('build/pub/BioSignalX_Report.pdf')
          HTML(filename=str(html_path)).write_pdf(str(pdf_path))
          print('PDF written:', pdf_path)
          PY

      - name: Fallback Export (nbconvert)
        if: steps.weasy.outcome == 'failure'
        run: |
          pip install nbconvert
          echo "Starting nbconvert fallback (timeout 8m)"
          timeout 480s python - <<'PY' || echo 'nbconvert fallback timed out or failed'
          from pathlib import Path
          import nbformat as nbf
          from nbconvert import PDFExporter

          html = Path('build/pub/combined.html').read_text(encoding='utf-8')
          nb = nbf.v4.new_notebook()
          nb.cells.append(nbf.v4.new_markdown_cell(html))
          pdf_exporter = PDFExporter()
          (body, resources) = pdf_exporter.from_notebook_node(nb)
          Path('build/pub/BioSignalX_Report.pdf').write_bytes(body)
          print('PDF written via nbconvert')
          PY

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BioSignalX_Report
          path: build/pub/BioSignalX_Report.pdf

      - name: Build Manuscript HTML from Markdown
        shell: python
        run: |
          print('--- START: manuscript HTML build ---')
          from pathlib import Path
          import base64
          import re
          try:
            import markdown as md
            renderer = 'markdown'
          except Exception:
            import mistune as md
            renderer = 'mistune'

          md_path = Path('docs/manuscript_draft.md')
          html_path = Path('build/pub/manuscript_draft.html')
          html_path.parent.mkdir(parents=True, exist_ok=True)
          if not md_path.exists():
            raise SystemExit('manuscript_draft.md not found. Ensure docs sync ran.')
          text = md_path.read_text(encoding='utf-8')
          if renderer == 'markdown':
            html = md.markdown(text, extensions=['fenced_code','tables'])
          else:
            html = md.create_markdown(renderer='html')(text)
          # Inline images (PNG) referenced by relative paths
          def repl_img(m):
            src = m.group(1)
            p = Path(src)
            if not p.exists():
              # try results/plots path resolution
              p2 = Path('results/plots') / p.name
              if p2.exists():
                p = p2
            if p.exists() and p.suffix.lower() in ['.png','.jpg','.jpeg']:
              b64 = base64.b64encode(p.read_bytes()).decode('utf-8')
              mime = 'image/png' if p.suffix.lower() == '.png' else 'image/jpeg'
              return f"src=\"data:{mime};base64,{b64}\""
            return f"src=\"{src}\""
          html = re.sub(r"src=\"([^\"]+)\"", repl_img, html)
          html = """
          <!doctype html><html><head><meta charset='utf-8'><title>BioSignalX Manuscript</title></head>
          <body>{}</body></html>
          """.format(html)
          html_path.write_text(html, encoding='utf-8')
          print('Manuscript HTML built:', html_path)
          print('--- END: manuscript HTML build ---')

      - name: Export Manuscript PDF (WeasyPrint)
        id: weasy_ms
        continue-on-error: true
        run: |
          echo "Starting Manuscript WeasyPrint export (timeout 6m)"
          timeout 360s python - <<'PY' || echo 'Manuscript WeasyPrint timed out or failed'
          from pathlib import Path
          from weasyprint import HTML

          html_path = Path('build/pub/manuscript_draft.html')
          pdf_path = Path('build/pub/BioSignalX_Manuscript.pdf')
          HTML(filename=str(html_path)).write_pdf(str(pdf_path))
          print('Manuscript PDF written:', pdf_path)
          PY

      - name: Fallback Manuscript Export (nbconvert)
        if: steps.weasy_ms.outcome == 'failure'
        run: |
          pip install nbconvert
          echo "Starting Manuscript nbconvert fallback (timeout 6m)"
          timeout 360s python - <<'PY' || echo 'Manuscript nbconvert fallback timed out or failed'
          from pathlib import Path
          import nbformat as nbf
          from nbconvert import PDFExporter

          html = Path('build/pub/manuscript_draft.html').read_text(encoding='utf-8')
          nb = nbf.v4.new_notebook()
          nb.cells.append(nbf.v4.new_markdown_cell(html))
          pdf_exporter = PDFExporter()
          (body, resources) = pdf_exporter.from_notebook_node(nb)
          Path('build/pub/BioSignalX_Manuscript.pdf').write_bytes(body)
          print('Manuscript PDF written via nbconvert')
          PY

      - name: Upload manuscript artifact
        uses: actions/upload-artifact@v4
        with:
          name: BioSignalX_Manuscript
          path: build/pub/BioSignalX_Manuscript.pdf

      - name: Stage report files for validation
        run: |
          echo "::group::Stage report files for validation"
          mkdir -p reports/history
          if [ -f build/pub/BioSignalX_Report.pdf ]; then cp build/pub/BioSignalX_Report.pdf reports/BioSignalX_Report.pdf; fi
          echo "::endgroup::"

      - name: Validate report completeness
        id: validate
        run: |
          echo "::group::Validate report completeness"
          python scripts/validate_publication.py
          STATUS=$(cat build/pub/validation_status.txt 2>/dev/null || echo "FAIL")
          echo "Validation status: $STATUS"
          if [ "$STATUS" = "OK" ]; then echo "commit_ok=true" >> $GITHUB_OUTPUT; else echo "commit_ok=false" >> $GITHUB_OUTPUT; fi
          echo "::endgroup::"

      - name: Upload validation context
        uses: actions/upload-artifact@v4
        with:
          name: pub-context
          path: |
            reports/**
            results/**
            docs/manuscript_draft.md
            build/pub/**

      - name: Cleanup lingering processes
        if: always()
        run: |
          echo "Cleaning up lingering processes (weasyprint/nbconvert/chromium/wkhtmltopdf)..."
          pkill -f weasyprint || true
          pkill -f nbconvert || true
          pkill -f chromium || true
          pkill -f wkhtmltopdf || true
          pkill -f chrome || true
          echo "Cleanup done."

  selftest:
    name: Self-Test Validation
    runs-on: ubuntu-latest
    needs: [export]
    outputs:
      selftest_ok: ${{ steps.selftest.outputs.selftest_ok }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download validation context
        uses: actions/download-artifact@v4
        with:
          name: pub-context
          path: .

      - name: Run self-test validation (dry-run)
        id: selftest
        run: |
          echo "::group::Self-Test Validation"
          set +e
          python scripts/validate_publication.py --dry-run
          CODE=$?
          if [ $CODE -eq 0 ]; then \
            echo "selftest_ok=true" >> $GITHUB_OUTPUT; \
            echo "## Self-Test Validation" >> $GITHUB_STEP_SUMMARY; \
            echo "<p style='color:green'><strong>PASSED</strong> — All required artifacts present.</p>" >> $GITHUB_STEP_SUMMARY; \
          else \
            echo "selftest_ok=false" >> $GITHUB_OUTPUT; \
            echo "## Self-Test Validation" >> $GITHUB_STEP_SUMMARY; \
            echo "<p style='color:red'><strong>FAILED</strong> — Missing or incomplete artifacts. Commit will be skipped.</p>" >> $GITHUB_STEP_SUMMARY; \
          fi
          echo "Exit code: $CODE"
          echo "::endgroup::"
          exit 0

  artifact_integrity:
    name: Artifact Integrity Check
    runs-on: ubuntu-latest
    needs: [selftest]
    outputs:
      integrity_ok: ${{ steps.integrity.outputs.integrity_ok }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download publication context
        uses: actions/download-artifact@v4
        with:
          name: pub-context
          path: .

      - name: Verify artifact integrity
        id: integrity
        run: |
          echo "::group::Artifact Integrity Check"
          python scripts/artifact_integrity_check.py
          STATUS=$(cat build/pub/integrity_status.txt 2>/dev/null || echo DRIFT)
          if [ "$STATUS" = "OK" ]; then echo "integrity_ok=true" >> $GITHUB_OUTPUT; else echo "integrity_ok=false" >> $GITHUB_OUTPUT; fi
          if [ "$STATUS" = "OK" ]; then \
            echo "## Artifact Integrity" >> $GITHUB_STEP_SUMMARY; \
            echo "<p style='color:green'><strong>Integrity Verified ✅</strong></p>" >> $GITHUB_STEP_SUMMARY; \
          else \
            echo "## Artifact Integrity" >> $GITHUB_STEP_SUMMARY; \
            echo "<p style='color:red'><strong>Integrity Drift Detected</strong> — hashes changed or files missing. Commit will be blocked.</p>" >> $GITHUB_STEP_SUMMARY; \
          fi
          echo "::endgroup::"

  publish:
    runs-on: ubuntu-latest
    needs: [export, selftest, artifact_integrity]
    if: needs.export.outputs.commit_ok == 'true' && needs.selftest.outputs.selftest_ok == 'true' && needs.artifact_integrity.outputs.integrity_ok == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Commit PDF to repo
        run: |
          echo "--- START: commit PDFs ---"
          mkdir -p reports
          cp build/pub/BioSignalX_Report.pdf reports/BioSignalX_Report.pdf || true
          mkdir -p reports/history
          if [ -f build/pub/versioned_name.txt ]; then \
            VNAME=$(cat build/pub/versioned_name.txt); \
            cp build/pub/BioSignalX_Report.pdf reports/history/$VNAME || true; \
          fi
          if [ -f reports/history/versions.json ]; then echo 'versions.json present'; else echo 'versions.json missing?'; fi
          if [ -f build/pub/BioSignalX_Manuscript.pdf ]; then cp build/pub/BioSignalX_Manuscript.pdf reports/BioSignalX_Manuscript.pdf || true; fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add reports/BioSignalX_Report.pdf reports/BioSignalX_Manuscript.pdf reports/history/*.pdf reports/history/versions.json || true
          git commit -m "ci: add artifact integrity verification step before publication" || echo "No changes to commit"
          git push || echo "Git push failed"
          echo "--- END: commit PDFs ---"
