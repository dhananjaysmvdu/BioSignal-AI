name: Update Documentation

on:
  schedule:
    - cron: '0 2 * * 0'  # Weekly at 02:00 UTC
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install from lock
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.lock
      - name: Lint & Static Checks
        continue-on-error: true
        run: |
          ruff check . --output-format=github
      - name: Enforce Critical Lint (F/E)
        run: |
          ruff check . --output-format=github --select F,E
      - name: Run Tests
        run: |
          python -m pytest -q

  update-docs:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install from lock
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.lock
      - name: Generate Docs Updates
        shell: bash
        run: |
          python - <<'PY'
import os, json
from datetime import datetime
from pathlib import Path

ROOT = Path('.')
DOCS = ROOT / 'docs'
DOCS.mkdir(exist_ok=True)
RESULTS = ROOT / 'results'
# 1) compliance_guidelines.md: append CI & evaluation summaries
cg = DOCS / 'compliance_guidelines.md'
ci_summary = f"\n\n## CI Summary (Auto)\n- Last run: {datetime.utcnow().isoformat()}Z\n- Tests: see Actions summary\n- Lint: Ruff (F/E errors block, W/B/I warn)\n"
# evaluation summary (if exists)
fs = RESULTS / 'fairness_summary.json'
site_metrics = RESULTS / 'site_metrics.csv'
eval_summary = "\n## Evaluation Summary (Auto)\n"
if fs.exists():
    try:
        data = json.loads(fs.read_text(encoding='utf-8'))
        eval_summary += f"- Fairness groups: {len(data.get('aggregates', []))}\n- ΔAUC (max): {data.get('delta_auc')}\n- ΔECE (max): {data.get('delta_ece')}\n"
    except Exception:
        eval_summary += "- Fairness summary not parsable.\n"
else:
    eval_summary += "- No fairness summary found.\n"
text = "# Compliance Guidelines\n" if not cg.exists() else cg.read_text(encoding='utf-8')
text = text.rstrip() + ci_summary + eval_summary
cg.write_text(text, encoding='utf-8')

# 2) README badges & nightly status
rd = ROOT / 'README.md'
if rd.exists():
    r = rd.read_text(encoding='utf-8')
else:
    r = "# BioSignal-AI\n"
# inject/update badges block
badge_block = (
    "\n[![Tests](https://github.com/${{ github.repository }}/actions/workflows/tests.yml/badge.svg)](https://github.com/${{ github.repository }}/actions/workflows/tests.yml) "
    "[![Nightly Report](https://github.com/${{ github.repository }}/actions/workflows/publish_eval_report.yml/badge.svg)](https://github.com/${{ github.repository }}/actions/workflows/publish_eval_report.yml) "
    "[![Docs Sync](https://github.com/${{ github.repository }}/actions/workflows/update_docs.yml/badge.svg)](https://github.com/${{ github.repository }}/actions/workflows/update_docs.yml)\n"
)
if 'actions/workflows/tests.yml/badge.svg' in r:
    # replace existing badges line
    import re
    r = re.sub(r"\n\[!\[Tests].*update_docs.yml\)\n", "\n"+badge_block, r, flags=re.S)
else:
    r = r.rstrip()+"\n"+badge_block

# latest nightly status
nightly = RESULTS / 'report_summary.html'
if nightly.exists():
    status = f"\nLatest nightly report generated at: {datetime.utcnow().isoformat()}Z (see results/report_summary.html)\n"
else:
    status = "\nLatest nightly report not found.\n"
rd.write_text(r+status, encoding='utf-8')

# 3) literature_summary.md: append last validation date
lit = DOCS / 'literature_summary.md'
line = f"\nLast validation date: {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')}\n"
if lit.exists():
    lit.write_text(lit.read_text(encoding='utf-8').rstrip()+line, encoding='utf-8')
else:
    lit.write_text("Literature Summary\n"+line, encoding='utf-8')

print('Docs updated.')
PY
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: auto-sync compliance and status reports"
          file_pattern: |
            docs/compliance_guidelines.md
            README.md
            docs/literature_summary.md
