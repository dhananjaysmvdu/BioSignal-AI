name: MV-CRS Horizon Coherence Engine

on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 08:00 UTC
  workflow_dispatch:

jobs:
  horizon-coherence:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Horizon Coherence Engine
        id: hce
        run: |
          python scripts/mvcrs/mvcrs_horizon_coherence.py || true
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Evaluate Coherence Status
        id: eval
        run: |
          if [ -f state/mvcrs_horizon_coherence.json ]; then
            STATUS=$(jq -r '.coherence_status // "unknown"' state/mvcrs_horizon_coherence.json)
            CONFIDENCE=$(jq -r '.confidence // 0' state/mvcrs_horizon_coherence.json)
            echo "Coherence status: $STATUS"
            echo "Confidence: $CONFIDENCE"
            if [ "$STATUS" = "conflict" ] && [ "$(echo "$CONFIDENCE > 0.65" | bc)" = "1" ]; then
              echo "conflict_detected=true" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "conflict_detected=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "conflict_detected=false" >> $GITHUB_OUTPUT
            echo "⚠ Missing horizon coherence state"
          fi

      - name: Upload HCE Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mvcrs-hce-${{ github.run_number }}
          path: |
            state/mvcrs_horizon_coherence.json
            logs/mvcrs_hce_log.jsonl
          retention-days: 90

      - name: Create Fix Branch on Conflict
        if: steps.eval.outputs.conflict_detected == 'true'
        run: |
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          BRANCH_NAME="fix/mvcrs-hce-$TIMESTAMP"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          git add state/mvcrs_horizon_coherence.json logs/mvcrs_hce_log.jsonl || true
          git commit -m "chore: HCE conflict detected - auto-created fix branch" || true
          git push origin "$BRANCH_NAME" || true
          echo "✓ Created fix branch: $BRANCH_NAME"

      - name: Append Audit Marker (Verified)
        if: steps.eval.outputs.conflict_detected == 'false'
        run: |
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          echo "<!-- MVCRS_HCE: VERIFIED $TIMESTAMP -->" >> INSTRUCTION_EXECUTION_SUMMARY.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add INSTRUCTION_EXECUTION_SUMMARY.md
          git commit -m "chore: HCE verification marker $TIMESTAMP" || true
          git push || true

      - name: Append Audit Marker (Conflict)
        if: steps.eval.outputs.conflict_detected == 'true'
        run: |
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          echo "<!-- MVCRS_HCE: CONFLICT $TIMESTAMP -->" >> INSTRUCTION_EXECUTION_SUMMARY.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add INSTRUCTION_EXECUTION_SUMMARY.md
          git commit -m "chore: HCE conflict marker $TIMESTAMP" || true
          git push || true

      - name: Fail workflow on conflict
        if: steps.eval.outputs.conflict_detected == 'true'
        run: |
          echo "::error::HCE detected conflict across governance horizons with high confidence"
          exit 1
