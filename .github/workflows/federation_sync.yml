name: Federation Sync Resilience

on:
  schedule:
    - cron: '30 3 * * 2'
  workflow_dispatch:

jobs:
  federation-sync:
    runs-on: ubuntu-latest
    env:
      MAX_ATTEMPTS: 3
      BACKOFF_SECONDS: 5,15,45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install base dependencies
        run: python -m pip install --upgrade pip pyyaml

      - name: Execute federation sync with smart retry
        shell: pwsh
        run: |
          $maxAttempts = [int]$env:MAX_ATTEMPTS
          $delays = @($env:BACKOFF_SECONDS.Split(',') | ForEach-Object {[int]$_})
          if ($delays.Count -lt $maxAttempts) {
              $additional = @()
              for ($i = $delays.Count; $i -lt $maxAttempts; $i++) { $additional += 45 }
              $delays += $additional
          }

          $attempt = 0
          $repoRoot = (Get-Location).Path
          $logPath = Join-Path $repoRoot 'logs/workflow_failures.jsonl'
          New-Item -ItemType Directory -Force -Path (Split-Path $logPath) | Out-Null

          while ($attempt -lt $maxAttempts) {
              $attempt++
              $errorMessage = $null
              Write-Host "[Federation Sync] Attempt $attempt of $maxAttempts"
              try {
                  pwsh -File scripts/federation/run_federation_sync.ps1
                  $exitCode = $LASTEXITCODE
              } catch {
                  $exitCode = 1
                  $errorMessage = $_.Exception.Message
              }

              if ($exitCode -eq 0) {
                  Write-Host "Federation sync succeeded on attempt $attempt."
                  break
              }

              if (-not $errorMessage) {
                  $errorMessage = 'Process returned non-zero exit code.'
              }

              $payload = [ordered]@{
                  timestamp = (Get-Date).ToUniversalTime().ToString('o')
                  workflow = 'federation_sync'
                  attempt = $attempt
                  exit_code = $exitCode
                  message = $errorMessage
              } | ConvertTo-Json -Compress
              $payload | Out-File -FilePath $logPath -Append -Encoding utf8

              if ($attempt -ge $maxAttempts) {
                  Write-Error "Federation sync failed after $maxAttempts attempts."
                  exit $exitCode
              }

              if ($attempt -eq ($maxAttempts - 1)) {
                  Write-Host "Installing dependencies before final retry..."
                  python -m pip install -r requirements.txt
              }

              $delayIndex = [Math]::Min($attempt, $delays.Count) - 1
              $sleepFor = $delays[$delayIndex]
              Write-Host "Waiting $sleepFor seconds before next attempt."
              Start-Sleep -Seconds $sleepFor
          }
